#!/usr/bin/perl -w
use strict;
use lib("$ENV{'Home120Proof'}/bin/");
BEGIN {
    print "Lib path: $ENV{'Home120Proof'}/bin/\n";
}
use Daemon;
my $PORT = 9116;

if(`lsof -i :$PORT`){
    `echo quit | nc 127.0.0.1 $PORT`;
    for(0..5){
	if(`lsof -i :$PORT`){
	    warn "wait for port $PORT to be free";
	    sleep 1;
	}else{
	    last;
	}
    }
    `lsof -i :$PORT` and die "Port $PORT in use";
}

## Copy the definitiuons of mod-host simulator's made by modep front
## end
warn "Run ExtractModep";
print `$ENV{"Home120Proof"}/bin/ExtractModep`;
warn "Ran ExtractModep";


## Start our own version of modhost
## Start mod-host
warn "Start mod-host";
$ENV{LV2_PATH} = '/usr/modep/lv2';

print `/home/patch/mod-host/mod-host -p $PORT`;
warn "Started mod-host";

## Wait for it to get started
sleep 1;

print `lsof -i:$PORT`;

## Create the simulators
warn "Wait for jack";
`jack_wait -w`;
warn "Create simulators";

print `$ENV{"Home120Proof"}/bin/ModhostSimulators`;
warn "Created simulators";
