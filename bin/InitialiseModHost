#!/usr/bin/perl -w
use strict;
use lib("$ENV{'Home120Proof'}/bin/");
use Daemon;
my $PORT = 9116;

if(`lsof -i :$PORT`){
    `echo quit | nc 127.0.0.1 $PORT`;
    sleep 1;
    `lsof -i :$PORT` and die "Port $PORT in use";
    print "Killed old mod-host on $PORT\n";
}

## Copy the definitiuons of mod-host simulator's made by modep front
## end
warn "Run ExtractModep";
print `$ENV{"Home120Proof"}/bin/ExtractModep`;
warn "Ran ExtractModep";


## Start our own version of modhost
## Start mod-host
my $pid = fork();
if(!$pid){
    warn "Start mod-host";
    $ENV{LV2_PATH} = '/usr/modep/lv2';
    run_daemon("/home/patch/mod-host/mod-host -p $PORT");
    warn "Started mod-host";
    exit 0;
}

waitpid($pid, 0);

## Wait for it to get started
sleep 1;

## Create the simulators
warn "Wait for jack";
`jack_wait -w`;
warn "Create simulators";

print `$ENV{"Home120Proof"}/ModhostSimulators`;
warn "Created simulators";
